<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Client Visa Portal - Chat</title>
  <link href="{{url_for('static',filename='css/bootstrap.min.css')}}" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" href="{{url_for('static', filename='styles/chat.css')}}" />
  <link rel="stylesheet" href="{{url_for('static', filename='styles/client/client.css')}}" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
</head>

<body data-room-id="{{ room_id }}">
  <header>
    <nav class="navbar">
      <div class="logo"><a class='vc' href="{{url_for('index')}}">Visa Consultancy</a></div>
      <ul class="nav-links">
        <li><button id="logoutBtn" class="btn btn-danger">Logout</button></li>
      </ul>
    </nav>

  </header>
  <script src="{{url_for('static',filename='js/bootstrap.min.js')}}" type="text/javascript"></script>
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  {% for category, message in messages %}
  <div class="alert alert-{{ category }} " role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  {% endfor %}
  {% endif %}
  {% endwith %}<br>
  <div class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-md-8 col-lg-6">
        <div class="card shadow-sm">
          <div class="card-header text-center">
            <h2 class="h4 mb-0">Agent Client Chat</h2>
          </div>
          <div id="chat-box" class="card-body chat-box">
            {% for msg in messages %}
            <div
              class="chat-message {% if msg.sender_id == session.user_id %}user-message{% else %}agent-message{% endif %}">
              <strong>{{ msg.first_name }} {{ msg.last_name }}:</strong> {{ msg.message }}
            </div>
            {% endfor %}
          </div>
          <div class="card-footer">
            <form id="chat-form">
              <div class="input-group">
                <input type="text" id="chat-input" class="form-control" placeholder="Type your message..." required
                  aria-label="Your message" />
                <button class="btn btn-primary" type="submit" id="button-send">Send</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    xintegrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>
  <script>
  document.addEventListener("DOMContentLoaded", function () {
    // Passing both user ID and full name from session to JavaScript
    const currentUserID = "{{ session.user_id }}";
    const currentUserName = "{{ session.get('first_name', '') }} {{ session.get('last_name', '') }}".trim();
    const roomID = document.body.dataset.roomId;
    const socket = io();
    const chatForm = document.getElementById("chat-form");
    const chatInput = document.getElementById("chat-input");
    const chatBox = document.getElementById("chat-box");

    function addMessageToBox(data) {
      const messageDiv = document.createElement("div");
      
      // check the message is from the current user or someone else
      const messageClass = String(data.sender_id) === String(currentUserID) 
        ? 'user-message' 
        : 'agent-message';

      messageDiv.className = `chat-message ${messageClass}`;
      
      const strong = document.createElement("strong");
      // using sender name which is same for both loding old and real-time messages
      strong.textContent = `${data.sender_name}: `; 
      messageDiv.appendChild(strong);
      messageDiv.appendChild(document.createTextNode(data.message));
      
      chatBox.appendChild(messageDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    socket.on('connect', () => {
      console.log("Connected to server. Joining room...");
      const roomID = document.body.dataset.roomId;
      if (roomID) {
        socket.emit("join", { room: roomID });
      } else {
        console.error("Could not find Room ID on the page!");
      }
    });

    socket.on("status", data => {
      console.log("Status update:", data.msg);
    });
    socket.on("receive_message", data => {
      addMessageToBox(data);
    });
    
    chatForm.addEventListener('submit', function (e) {
      e.preventDefault(); 
      const message = chatInput.value.trim();

      if (message) {
        const selfMessageData = {
          sender_id: currentUserID,
          sender_name: currentUserName,
          message: message
        };

        addMessageToBox(selfMessageData);

        socket.emit("send_message", { message: message });
        
        chatInput.value = ""; 
      }
    });

    chatBox.scrollTop = chatBox.scrollHeight;
  });

  document.getElementById("logoutBtn").addEventListener("click", function () {
    confirm("Go to home page for loging out!")
  });
</script>
</body>

</html>